<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Ethicode | OX 퀴즈 15문제</title>
  <link rel="stylesheet" href="quiz_style.css" />
</head>
<body>
  <div class="container">
    <header>
      <img src="detective-icon.png" alt="탐정 아이콘" class="icon">
      <h1><span class="highlight">Ethicode</span> 탐정님의 이름은...</h1>
    </header>

    <!-- 사용자 정보 입력 폼 -->
    <div id="user-form" class="form-container">
      <p class="intro">
        퀴즈를 시작하기 전에 정보를 입력해주세요!<br>
        전화번호 추첨을 통해 기프티콘 보내드리겠습니다.<br>
        많은 참여 부탁드릴게요..♡
      </p>

      <div class="form-row">
        <label for="username">이름：</label>
        <input type="text" id="username" required class="underline-input">
      </div>


      <div class="form-row">
        <label for="phone1">전화번호：</label>
        <div class="phone-wrapper">
          <input type="text" id="phone1" minlength = "3" maxlength="3" class="phone-part" pattern="[0-9]*" inputmode="numeric">
          <span>-</span>
          <input type="text" id="phone2" minlength = "3" maxlength="4" class="phone-part" pattern="[0-9]*" inputmode="numeric">
          <span>-</span>
          <input type="text" id="phone3" minlength = "3" maxlength="4" class="phone-part" pattern="[0-9]*" inputmode="numeric">
        </div>
      </div>

      <button class="btn" onclick="startQuiz()">퀴즈 시작</button>
    </div>

    <!-- 퀴즈 영역 -->
    <div id="quiz-container" style="display:none;"></div>

    <!-- 정답 여부 팝업 -->
    <div id="popup"></div>

    <!-- 소감문 작성 영역 -->
    <div id="final-form" style="display:none;">
      <h2>퀴즈가 끝났습니다! 소감문을 작성해주세요：</h2>
      <textarea id="feedback" placeholder="소감을 적어주세요..."></textarea><br>
      <button class="btn" onclick="submitFeedback()">소감 제출</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="quiz_data.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCgtY7J_DbPq5jf7Z1mzoa7DjZy7sZXZRO",
      authDomain: "ethicode-quiz.firebaseapp.com",
      projectId: "ethicode-quiz",
      storageBucket: "ethicode-quiz.appspot.com",
      messagingSenderId: "957429525105",
      appId: "1:957429525105:web:671f4094e8aec54c9889d0",
      measurementId: "G-J7Q6S0JPH2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let username = '';
    let phone = '';
    let gender = '';
    let age = '';

    let currentQuestion = 0; // 현재 문제 번호
    let score = 0; // 점수


    // 사용자 정보를 입력받고 퀴즈 시작
    function startQuiz() {

      username = document.getElementById("username").value.trim();
      const phone1 = document.getElementById("phone1").value.trim();
      const phone2 = document.getElementById("phone2").value.trim();
      const phone3 = document.getElementById("phone3").value.trim();
      phone = `${phone1}-${phone2}-${phone3}`;

      //gender = document.querySelector('input[name="gender"]:checked')?.value;
      //age = document.getElementById("age").value;

      if (
        !username ||
        phone1.length < 3 ||
        phone2.length < 3 ||
        phone3.length < 4
      ) {
      alert("모든 항목을 정확히 입력해주세요.");
      return;
    }

      document.querySelector('header .icon').style.display = 'none';
      document.querySelector('header h1').innerHTML = '과연 사진 속의 인물은 <span class="highlight">범인</span>일까요?';

      // 사용자 정보 입력 폼 숨기기
      document.getElementById("user-form").style.display = "none";

      // 퀴즈 화면 보이기
      document.getElementById("quiz-container").style.display = "block";

      // 첫 번째 문제 로드
      loadQuestion();
    }

    function loadQuestion() {
      const quizContainer = document.getElementById("quiz-container");

      if (currentQuestion < quizData.length) {
        const q = quizData[currentQuestion];

        // 이미지 미리 로딩
        const img = new Image();
        img.src = q.img;
        quizContainer.style.opacity = 0; // 먼저 투명하게 설정

        img.onload = () => {
          quizContainer.innerHTML = `
            <div class="quiz-flex-box">
              <div class="left-side">
                <img src="${q.img}" alt="문제 이미지" class="profile-img" />
              </div>

              <div class="right-side">
                <div class="profile-info">
                  <p><strong>이름:</strong> ${q.name}</p>
                  <p><strong>생년월일/나이：</strong> ${q.birth} / ${q.age}</p>
                  <p><strong>출생지 / 국적：</strong> ${q.origin}</p>
                  <p><strong>키 / 몸무게：</strong> ${q.heightWeight}</p>
                  <p><strong>인종：</strong> ${q.race}</p>
                </div>

                <div class="buttons">
                  <button onclick="checkAnswer('O')">O</button>
                  <button onclick="checkAnswer('X')">X</button>
                </div>
              </div>

            </div>
          `;
          // 부드럽게 보이게 하기
          setTimeout(() => {
            quizContainer.style.opacity = 1;
          }, 50);
        };
      } else {
        let resultMessage = '';
      if (score >= 12) {
        resultMessage = '훗, 우수한 탐정이군. 그래도 정보 수첩으 한번 확인해봐.';
      } else if (score >= 6) {
        resultMessage = '조금만 더 노력하면, 우수한 탐정이 될 수 있겠는 걸? 정보 수첩을 한 번 읽어보게나.';
      } else {
        resultMessage = '탐정이 되기 위해 노력이 필요하겠는 걸... 정보 수첩을 읽어보게나.';
      }

quizContainer.innerHTML = `
  <h2>퀴즈 종료! 당신의 점수는 ${score}점입니다.</h2>
  <p class="result-message">${resultMessage}</p>
`;

document.getElementById("final-form").style.display = "block";
        document.getElementById("final-form").style.display = "block";
      }
    }

    function checkAnswer(userAnswer) {
      const correctAnswer = quizData[currentQuestion].answer;
      const isCorrect = userAnswer === correctAnswer;
      if (isCorrect) score++;
      showPopup(isCorrect);
    }

    // 팝업을 표시하는 함수
    function showPopup(isCorrect) {
      const popup = document.getElementById("popup");
      const quizContainer = document.getElementById("quiz-container");
      
      popup.innerText = isCorrect ? "정답입니다!" : "틀렸습니다!";
      popup.style.display = "block";
      popup.style.opacity = 1;

      // 1.5초 후 자동으로 팝업 숨기기
      setTimeout(() => {
        popup.style.opacity = 0;
        setTimeout(() => {
          popup.style.display = "none";
          currentQuestion++;
          loadQuestion();   // 다음 문제로 이동
          setTimeout(() => {
          quizContainer.style.opacity = 1;
          }, 100);
        }, 500);
      }, 1500);
    }

    function submitFeedback() {
      const feedback = document.getElementById("feedback").value;
      if (feedback.trim() === "") {
        alert("소감문을 작성해주세요.");
        return;
      }

      db.collection("responses").add({
        username,
        phone,
        score,
        feedback,
        timestamp: new Date()
      })
      .then(() => {
        console.log("Firebase 저장 성공!");

      const popup = document.getElementById("popup");
        popup.innerText = "정보 수첩으로 이동 중 🕵️‍♂️";
        popup.style.display = "block";
        popup.style.opacity = 1;

        // 2초 후 information.html로 이동
        setTimeout(() => {
          popup.style.opacity = 0;
          setTimeout(() => {
            popup.style.display = "none";
            window.location.href = "information.html";
          }, 500); // fade-out 시간
        }, 3000);
      })
      .catch((error) => {
        console.error("Firebase 저장 실패:", error);
        alert("오류가 발생했습니다. 다시 시도해주세요.");
      });
    }

    // 함수들 다 끝난 뒤
    document.querySelectorAll('.phone-part').forEach((input, index, inputs) => {
      input.addEventListener('input', () => {
       // 숫자 이외 입력 불가능하게 설정
      input.value = input.value.replace(/\D/g, '');

        if (input.value.length === input.maxLength && index < inputs.length - 1) {
          inputs[index + 1].focus();
        }
      });
    });
  </script>
</body>
</html>
